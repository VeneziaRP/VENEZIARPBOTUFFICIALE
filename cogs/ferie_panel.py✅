# cogs/ferie_panel.py
import discord
from discord.ext import commands
from discord import app_commands
from datetime import datetime

# ====== CONFIG ======
FERIE_PANEL_COLOR = 0x4B7BEC  # blu elegante
PANEL_TITLE = "ğŸ“… Richieste Ferie â€” VeneziaRP"

# Ruoli che possono approvare (mostrati nellâ€™embed)
APPROVER_ROLE_IDS = {
    1408613537181466817,  # ğŸ‘‘ fondatore
    1408613538594947303,  # ğŸ‘‘ co-fondatore
}

# Se hai giÃ  la modale: ferma l'import a file esistenti
try:
    from views.ferie_request_view import FerieRequestModal
    HAS_MODAL = True
except Exception:
    FerieRequestModal = None
    HAS_MODAL = False


def _approver_mentions(guild: discord.Guild | None) -> str:
    if not guild:
        return "â€¢ Community Manager / Responsabile Staff / Supervisore"
    roles = []
    for rid in APPROVER_ROLE_IDS:
        r = guild.get_role(rid)
        if r:
            roles.append(f"{r.mention}")
    return " â€¢ ".join(roles) if roles else "â€¢ Community Manager / Responsabile Staff / Supervisore"


class FeriePanelView(discord.ui.View):
    def __init__(self):
        super().__init__(timeout=None)

    @discord.ui.button(
        label="Richiedi Ferie",
        emoji="ğŸ“",
        style=discord.ButtonStyle.primary,
        custom_id="ferie:open_form",
    )
    async def open_form(self, interaction: discord.Interaction, _: discord.ui.Button):
        if HAS_MODAL and FerieRequestModal:
            return await interaction.response.send_modal(FerieRequestModal(interaction.user))
        # fallback se la modale non Ã¨ ancora collegata
        await interaction.response.send_message(
            "ğŸ› ï¸ Il modulo ferie verrÃ  collegato qui. (Collega `FerieRequestModal` per aprirlo dal bottone.)",
            ephemeral=True
        )


class FeriePanel(commands.Cog):
    def __init__(self, bot: commands.Bot):
        self.bot = bot

    @app_commands.command(
        name="ferie_panel",
        description="Pubblica il pannello ufficiale per le richieste ferie (embed + bottone)."
    )
    @app_commands.checks.has_permissions(manage_guild=True)
    async def ferie_panel(self, interaction: discord.Interaction):
        g = interaction.guild

        descr = (
            "Benvenuto nel **pannello ufficiale** per le richieste ferie dello **Staff** di VeneziaRP.\n"
            "Le sezioni si aggiornano automaticamente al momento dellâ€™invio e della revisione.\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            "### ğŸ”¹ Come funziona\n"
            "1) Clicca **Richiedi Ferie** e compila il modulo.\n"
            "2) La richiesta arriva allo **staff responsabile** per la revisione.\n"
            "3) Ricevi lâ€™**esito** (âœ… approvata / âŒ rifiutata) in DM e nel canale dedicato.\n\n"
            "### ğŸ”¹ Requisiti\n"
            "â€¢ Essere **membro dello Staff attivo**\n"
            "â€¢ Indicare **date precise** (inizio/fine) e **motivazione valida**\n"
            "â€¢ Specificare se sei **parzialmente disponibile** in quei giorni\n\n"
            "### ğŸ”¹ Linee guida\n"
            "â€¢ Durata consigliata: **max 14 giorni consecutivi**\n"
            "â€¢ Le ferie **non** sospendono responsabilitÃ  o attivitÃ  **in corso**\n"
            "â€¢ In caso di urgenza, contatta un **responsabile**\n\n"
            "### ğŸ”¹ Chi approva\n"
            f"{_approver_mentions(g)}\n\n"
            "### ğŸ”¹ Esempio\n"
            "**Inizio:** 15-08-2025  â€¢  **Fine:** 25-08-2025\n"
            "**Motivazione:** Vacanza familiare\n"
            "**DisponibilitÃ :** 21â€“23\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            "### ğŸ’¡ Suggerimenti rapidi\n"
            "â€¢ Usa il formato **gg-mm-aaaa**\n"
            "â€¢ Descrivi **brevemente** la motivazione\n"
            "â€¢ Indica se sarai **reperibile** (es. solo la sera)\n"
            "â€¢ Se cambi piano, **avvisa lo staff**"
        )

        emb = discord.Embed(
            title=PANEL_TITLE,
            description=descr,
            color=discord.Color(FERIE_PANEL_COLOR)
        )
        if g and g.icon:
            emb.set_thumbnail(url=g.icon.url)
        emb.timestamp = datetime.utcnow()  # timestamp in alto a destra

        # ğŸ‘‡ qui mettiamo il logo del server piccolo sotto
        if g and g.icon:
            emb.set_footer(text="VeneziaRP | Richieste Ferie", icon_url=g.icon.url)
        else:
            emb.set_footer(text="VeneziaRP | Richieste Ferie")

        view = FeriePanelView()
        await interaction.response.send_message(embed=emb, view=view)


async def setup(bot: commands.Bot):
    await bot.add_cog(FeriePanel(bot))
    bot.add_view(FeriePanelView())  # view persistente
